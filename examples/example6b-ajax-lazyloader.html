<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>SlickGrid example 6: AJAX Load</title>
		<link rel="stylesheet" href="../slick.grid.css" type="text/css" media="screen" charset="utf-8" />
		<link rel="stylesheet" href="../css/smoothness/jquery-ui-1.8.16.custom.css" type="text/css" media="screen" charset="utf-8" />
		<link rel="stylesheet" href="examples.css" type="text/css" media="screen" charset="utf-8" />
		<style>
		.cell-story {
			white-space: normal!important;
			line-height: 19px!important;
		}
		</style>
	</head>
	<body>
		<div style="width:700px;float:left;">
			<div class="grid-header" style="width:100%">
				<label>Digg stories</label>
				<!--
				not implemented yet
				<span style="float:right;display:inline-block;">
					Search:
					<input type="text" id="txtSearch" value="apple">
				</span>
				-->
			</div>
			<div id="myGrid" style="width:100%;height:600px;margin-bottom:20px;"></div>
		</div>
		<div style="margin-left:750px;margin-top:40px;;">
				<h2>Demonstrates:</h2>
				<ul>
					<li>loading data through AJAX with LazyLoader</li>
					<li>custom row height</li>
				</ul>
				<h2>Note, not yet implemented in this example:</h2>
				<ul>
					<li>Sorting</li>
					<li>Searching</li>
				</ul>
				<h2>WARNING:</h2>
				<ul>
					<li>Digg API uses request rate limiting.  You may occasionally get an error if you do a frequent scrolling/resorting/searching.</li>
				</ul>
		</div>

		<script src="../lib/jquery-1.7.min.js"></script>
		<script src="../lib/jquery-ui-1.8.16.custom.min.js"></script>
		<script src="../lib/jquery.event.drag-2.0.min.js"></script>
		<script src="../lib/jquery.jsonp-1.1.0.min.js"></script>

		<script src="../slick.core.js"></script>
		<script src="../slick.lazyloader.js"></script>
		<script src="../slick.grid.js"></script>

		<script>
		var storyTitleFormatter = function(row, cell, value, columnDef, dataContext) {
			return "<b><a href='" + dataContext["link"] + "' target=_blank>" + dataContext["title"] + "</a></b><br/>" + dataContext["description"];
		};

		var columns = [
			{id:"num", name:"#", field:"index", width:40},
			{id:"story", name:"Story", width:580, formatter:storyTitleFormatter, cssClass:"cell-story"},
			{id:"diggs", name:"Diggs", field:"diggs", width:60, sortable:true}
		];

		var loader = new Slick.Data.LazyLoader({
			fetchData: getDiggFeed,
			blockSize: 40, // fetch 40 rows at a time
			numRows: 200 // will be overridden when data is retrieved
		});
		var gridOptions = {
			rowHeight: 64,
			editable: false,
			enableAddRow: false,
			enableCellNavigation: false,
			enableLazyLoading: true,
			renderDelay: 200 // wait a bit longer than default of 50 so we don't ask server for data we may not need
		};
		var searchstr = "apple"; // for now...
		function getDiggFeed(){
			var me = this;
			$.jsonp({
				url: "http://services.digg.com/search/stories?query=" + searchstr + "&offset=" + (me.top) +
						"&count=" + (me.bottom - me.top + 1) + "&appkey=http://slickgrid.googlecode.com&type=javascript",
				callbackParameter: "callback",
				cache: true, // Digg doesn't accept the autogenerated cachebuster param
				success: function (resp) {
					// this is only necessary if we want to synthesize an 'index' field to display (it is not in the data Digg)
					for (var i=0; i<(me.bottom - me.top + 1); i++) resp.stories[i].index = i + me.top;
					loader.setLength(resp.total);
					me.loadData(resp.stories);
				},
				error: function () {
					throw "Aw crap, error retrieving data for rows " + me.top + " to " + me.bottom;
				}
			});
		}

		$(function() {
			grid = new Slick.Grid("#myGrid", loader, columns, gridOptions);

			// TODO: still need to look at implementing sort and search
		});
		</script>
	</body>
</html>
