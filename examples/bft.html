<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
		<title>Big Fake Table example</title>
		<link rel="stylesheet" href="../slick.grid.css" type="text/css" media="screen" charset="utf-8" />
        <link rel="stylesheet" href="../css/smoothness/jquery-ui-1.8.5.custom.css" type="text/css" media="screen" charset="utf-8" />
		<link rel="stylesheet" href="examples.css" type="text/css" media="screen" charset="utf-8" />
		<style>
		.cell-story {
			white-space: normal!important;
      line-height: 19px!important;
		}

		.loading-indicator {
			display: inline-block;
			padding: 12px;
			background: white;
			-opacity: 0.5;
			color: black;
			font-weight: bold;
			z-index: 9999;
			border: 1px solid red;
			-moz-border-radius: 10px;
			-webkit-border-radius: 10px;
			-moz-box-shadow: 0 0 5px red;
			-webkit-box-shadow: 0px 0px 5px red;
			-text-shadow: 1px 1px 1px white;
		}

		.loading-indicator label {
			padding-left: 20px;
			background: url('../images/ajax-loader-small.gif') no-repeat center left;
		}
		</style>
	</head>
	<body>
		<div id="myGrid" style="width:100%;height:410px;"></div>

		<script src="../lib/jquery-1.4.3.min.js"></script>
		<script src="../lib/jquery.event.drag-2.0.min.js"></script>

		<script src="../slick.core.js"></script>
		<script src="../slick.remotecolumnarmodel.js"></script>
		<script src="../slick.grid.js"></script>

		<script>
		var grid;

		// id is required, can be the same as field but doesn't have to be
		// name is optional, but if omitted no header will appear
		// field is required, this is the mapping to the data object
		var columns = [
			{id:"col1", name:"Larry", field:"col1", width:100},
			{id:"col2", name:"Curly", field:"col2", width:100},
			{id:"col3", name:"Moe", field:"col3", width:100}
		];
		var loader = Slick.Data.makeRemoteModel({
			url: '/g16e/bigFakeTable/',
			colNames: (function(){
				return $.map(columns, function(el, i){
					return el.field;
				})
			}())
		});

		var options = {
			editable: false,
			enableAddRow: false,
			enableCellNavigation: false,
			enableColumnReorder: false // true by default, requires jquery-ui if true
		};

		$(function() {
			var ROWBUFFER = 25;
			var loadingIndicator = (function(){
				var ind = $("<span class='loading-indicator'><label>Buffering...</label></span>").appendTo(document.body).hide();
				var $g = $("#myGrid");
					ind.css("position", "absolute")
						.css("top", $g.position().top + $g.height()/2 - ind.height()/2)
						.css("left", $g.position().left + $g.width()/2 - ind.width()/2);
				return ind;
			}());
			grid = new Slick.Grid("#myGrid", loader, columns, options);

			function ensureDataLoaded(e, args) {
				args = args || {};
                var vp = grid.getViewport();
				// we don't want to load the data right away if user is scrolling quickly
				if (args.now || (args.top && Math.abs(args.top - vp.top) < ROWBUFFER )) { 
                	loader.ensureData(vp.top - ROWBUFFER, vp.bottom + ROWBUFFER);
				} else {
					setTimeout(function(){ ensureDataLoaded(null, {top: vp.top}) }, 500);
				}
            }

			function showDataStatus(){
				var vp = grid.getViewport(),
                	method = (loader.isDataReady(vp.top, vp.bottom)) ? 'hide' : 'show';
				loadingIndicator[method]();
			}

			grid.onViewportChanged.subscribe(ensureDataLoaded);
			grid.onViewportChanged.subscribe(showDataStatus);

			// avoid asking for more data while there is a request in flight
			loader.onDataLoading.subscribe(function() {
				grid.onViewportChanged.unsubscribe(ensureDataLoaded);
			});

			loader.onDataLoaded.subscribe(function(e,args) {
				// need to do this even if we are not trying to reload rows that are already loaded, not sure why though
				for (var i = args.from; i <= args.to; i++) grid.invalidateRow(i);

				grid.updateRowCount(); // if we know the rows won't change we don't need to do this every time
				grid.render(); // need to do this even if we're just adding new data
				grid.onViewportChanged.subscribe(ensureDataLoaded);
				ensureDataLoaded(null, {now: true}); // in case user scrolled since

				showDataStatus();
			});

			// load the first page
			ensureDataLoaded(null, {now: true});
		});
		</script>
	</body>
</html>
